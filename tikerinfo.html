<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Информация о тикере</title>
    <link rel="stylesheet" href="css/tikerinfo.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito Sans', sans-serif;
        }
        .error {
            border: 1px solid red;
        }
        .error-message {
            color: red;
            display: none;
        }
        .main-btn {
            display: flex;
            align-items: center;
        }
        .ticker-info-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <a href="main.html" id="header-link">
            <img src="images/ssini.png" alt="Главная">
        </a>
        <h3 class="header-title">Информация о тикере</h3>
    </header>
    <main>
        <p id="userInfo" class="main-p">Добро пожаловать, @неизвестный пользователь!</p>
        <p class="main-p">Введите торговую пару к USDT</p>
        <form id="tickerForm">
            <input id="tickerInput" class="main-input" placeholder="BTC">
            <span id="errorMessage" class="error-message">Поле пустое. Введите торговую пару</span>
            <div id="tickerInfo" class="ticker-info-container"></div>
            <div class="main-form">
                <button id="submitButton" class="main-btn">
                    <span style="margin-left: 5%; margin-right: 5%;">Получить информацию о тикере</span>
                    <img src="images/search.png" alt="Поиск">
                </button>
                <p>Последнее обновление - <span id="lastUpdate"></span></p>
            </div>
        </form>
    </main>
    <footer>
        <a href="setting.html" class="footer-link">
            <img src="images/setting_icon.png">
        </a>
        <a href="main.html" class="footer-link">
            <img class="active-btn" src="images/home.png">
        </a>
        <a href="profile.html" class="footer-link">
            <img src="images/profile_icon.png">
        </a>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // let tg = window.Telegram.WebApp;
            // tg.expand(); // Расширяем веб-приложение на весь экран

            // Получаем данные пользователя
            // const user = tg.initDataUnsafe.user;
            // const username = user.username ? user.username : 'неизвестный пользователь';

            // Отображаем никнейм пользователя
            // const userInfoContainer = document.getElementById('userInfo');
            // userInfoContainer.textContent = `Добро пожаловать, @${username}!`;

            const form = document.getElementById('tickerForm');
            const inputField = document.getElementById('tickerInput');
            const errorMessage = document.getElementById('errorMessage');
            const tickerInfoContainer = document.getElementById('tickerInfo');
            const lastUpdateSpan = document.getElementById('lastUpdate');

            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Предотвращаем реальную отправку формы

                const ticker = inputField.value.trim().toUpperCase();
                if (ticker === "") {
                    errorMessage.style.display = 'block';
                    inputField.classList.add('error');S
                    return;
                } else {
                    errorMessage.style.display = 'none';
                    inputField.classList.remove('error');
                }

                const apiUrl = `http://127.0.0.1:8000/api/ticker/${ticker}`;

                // Запрос данных с бэкенда FastAPI (замените на ваш реальный эндпоинт API)
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ticker: ticker })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const infoHTML = `<h3>Результат запроса</h3>
                        <p>Тикер: <span>${data.ticker}</span></p>
                        <p>Цена: <span>${data.current_price}$</span></p>
                        <p>Корреляция с BTC: <span>${data.correlation_with_btc}</span></p>
                        <p>Стандартный объем: <span>${data.standard_daily_volume}$</span></p>
                        <p>${data.volume_text}</p>
                        <div>
                            <hr>
                            <h4>Фандинг</h4>
                            ${data.funding_rates.map(rate => `
                                <p>${rate.time}: <span>${rate.rate} (${rate.change})</span></p>
                            `).join('')}
                        </div>
                        <div>
                            <hr>
                            <h4>Объём</h4>
                            ${data.volumes.map(volume => `
                                <p>${volume.time}: <span>${volume.volume}$</span></p>
                            `).join('')}
                        </div>`;
                    tickerInfoContainer.innerHTML = infoHTML;

                    // Обновляем время последнего обновления (пример)
                    const now = new Date();
                    lastUpdateSpan.textContent = now.toLocaleString('ru-RU');
                })
                .catch(error => {
                    console.error('Ошибка при получении данных о тикере:', error);
                    tickerInfoContainer.innerHTML = `<p>Ошибка при получении данных о тикере. Пожалуйста, попробуйте ещё раз позже.</p>`;
                });

                // Предотвращаем закрытие
                // tg.ready();
            });

            // Функция для форматирования чисел с запятыми
            function format_number_with_commas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

        });
    </script>
</body>
</html>
